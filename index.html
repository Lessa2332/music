<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' https: 'unsafe-inline' https://cdn.jsdelivr.net https://storage.googleapis.com; style-src 'self' 'unsafe-inline'; media-src * blob: data:;" />
    <title>ü•Ç –ó –î–Ω–µ–º –ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –í–∞–¥—ñ–∫!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: #000; }
        #videoBackground { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; transform: scaleX(-1); z-index: 1; display: none; }
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        #startButton { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 40px; font-size: 24px; background: linear-gradient(135deg, #ffd700, #ffed4e); border: none; border-radius: 15px; cursor: pointer; z-index: 10; color: #000; font-weight: bold; box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5); animation: pulse 2s infinite; }
        #greeting { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; text-align: center; color: white; font-size: clamp(24px, 5vw, 40px); font-weight: bold; text-shadow: 2px 2px 12px rgba(0,0,0,0.9); display: none; z-index: 10; padding: 25px 30px; background: linear-gradient(135deg, rgba(255, 107, 107, 0.95), rgba(255, 183, 77, 0.95)); border-radius: 25px; backdrop-filter: blur(15px); border: 4px solid rgba(255, 255, 255, 0.9); box-shadow: 0 20px 60px rgba(0,0,0,0.4); line-height: 1.3; }
        #loading, #error { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.9); color: white; text-align: center; z-index: 100; padding: 25px 30px; border-radius: 20px; border: 2px solid rgba(255, 255, 255, 0.3); display: none; max-width: 90%; width: 400px; }
        #loading { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .loader { width: 60px; height: 60px; border: 4px solid rgba(255, 107, 107, 0.3); border-top: 4px solid #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; }
        #debugPanel { position: fixed; top: 15px; right: 15px; background: rgba(0, 0, 0, 0.85); color: #4ECDC4; padding: 12px 15px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 12px; z-index: 50; border: 1px solid #4ECDC4; max-width: 300px; backdrop-filter: blur(10px); line-height: 1.5; display: block !important; }
        .debug-value { color: #FFD700; font-weight: bold; }
        .debug-good { color: #4ECDC4; }
        .debug-bad { color: #FF6B6B; }
        .sparkle { position: fixed; pointer-events: none; z-index: 5; animation: sparkle 1s forwards; }
        #cameraSwitchBtn { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); border: 2px solid rgba(255, 255, 255, 0.5); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.3s ease; display: none; }
        .indicator { position: fixed; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); color: white; padding: 8px 16px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.3); display: none; align-items: center; gap: 10px; z-index: 10; font-size: 14px; }
        #cameraIndicator { top: 20px; }
        #handIndicator { top: 70px; }
        .indicator.show { display: flex; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.05); } 100% { transform: translate(-50%, -50%) scale(1); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes sparkle { 0% { transform: scale(0) rotate(0deg); opacity: 1; } 100% { transform: scale(1) rotate(360deg); opacity: 0; } }
    </style>
</head>
<body>
    <video id="videoBackground" playsinline muted></video>
    <canvas id="canvas"></canvas>
    <button id="startButton">üéâ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–æ—Å—Ç!</button>
    <div id="greeting">–ó –¥–Ω–µ–º –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è, –í–∞–¥—ñ–∫!<br>–ó–∞ —Ç–≤–æ—î –∑–¥–æ—Ä–æ–≤'—è, —É—Å–ø—ñ—Ö–∏ —Ç–∞ –∫—Ä—É—Ç—ñ –ø—Ä–∏–≥–æ–¥–∏! ü•Ç</div>
    <div id="loading">
        <div class="loader"></div>
        <div id="loadingText">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR-—Å–∏—Å—Ç–µ–º–∏...</div>
    </div>
    <div id="error"></div>
    <div id="debugPanel">
        <div><strong>AR Debug Panel</strong></div>
        <div>–ö–∞–º–µ—Ä–∞: <span id="debugCamera" class="debug-value">...</span></div>
        <div>MediaPipe: <span id="debugMediaPipe" class="debug-value">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></div>
        <div>–†—É–∫ –∑–Ω–∞–π–¥–µ–Ω–æ: <span id="debugHands" class="debug-value">0</span></div>
        <div>–ö–µ–ª–∏—Ö: <span id="debugGlass" class="debug-value">–ü—Ä–∏—Ö–æ–≤–∞–Ω–æ</span></div>
    </div>
    <button id="cameraSwitchBtn" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É">üì∑</button>
    <div id="cameraIndicator" class="indicator">
        <span>üìπ</span><span id="cameraStatus">–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
    </div>
    <div id="handIndicator" class="indicator">
        <span>üñêÔ∏è</span><span id="handStatus">–ü–æ–∫–∞–∂—ñ—Ç—å –¥–æ–ª–æ–Ω—é</span>
    </div>

    <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –±–∞–Ω–¥–ª (mjs) - latest –≤–µ—Ä—Å—ñ—è -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.mjs" crossorigin="anonymous"></script>

    <script>
        (function() {
            'use strict';
           
            const CONFIG = {
                SMOOTHING_FACTOR: 0.6,
                HAND_NOT_DETECTED_THRESHOLD: 20,
                TARGET_FPS: 30,
                INITIAL_CAMERA: 'user',
                FALLBACK_CAMERA: 'environment'
            };
           
            const elements = {
                videoBackground: document.getElementById('videoBackground'),
                canvas: document.getElementById('canvas'),
                startButton: document.getElementById('startButton'),
                greeting: document.getElementById('greeting'),
                loading: document.getElementById('loading'),
                loadingText: document.getElementById('loadingText'),
                error: document.getElementById('error'),
                cameraSwitchBtn: document.getElementById('cameraSwitchBtn'),
                cameraIndicator: document.getElementById('cameraIndicator'),
                handIndicator: document.getElementById('handIndicator'),
                cameraStatus: document.getElementById('cameraStatus'),
                handStatus: document.getElementById('handStatus')
            };
           
            const debugEls = {
                camera: document.getElementById('debugCamera'),
                mediaPipe: document.getElementById('debugMediaPipe'),
                hands: document.getElementById('debugHands'),
                glass: document.getElementById('debugGlass')
            };
           
            const state = {
                isRunning: false,
                isFrontCamera: true,
                handLandmarker: null,
                videoStream: null,
                animationFrameId: null,
                detectedHands: [],
                lastRenderTime: 0,
                scene: null,
                camera: null,
                renderer: null,
                glassGroup: null,
                isGreetingVisible: false,
                lastPinchTime: 0,
                handNotDetectedCount: 0,
                smoothedLandmarks: null
            };
           
            class BirthdayARApp {
                constructor() {
                    this.init();
                }
               
                async init() {
                    try {
                        this.setupEventListeners();
                        await this.initThreeJS();
                        await this.initMediaPipe();
                        await this.startCamera();
                        this.hideLoading();
                        this.startRenderLoop();
                    } catch (error) {
                        this.handleError(error);
                    }
                }
               
                async initThreeJS() {
                    state.scene = new THREE.Scene();
                    state.scene.background = null;
                   
                    state.camera = new THREE.OrthographicCamera(
                        -window.innerWidth / 2,
                        window.innerWidth / 2,
                        window.innerHeight / 2,
                        -window.innerHeight / 2,
                        0.1,
                        1000
                    );
                    state.camera.position.z = 10;
                   
                    state.renderer = new THREE.WebGLRenderer({
                        canvas: elements.canvas,
                        alpha: true,
                        antialias: true
                    });
                    state.renderer.setSize(window.innerWidth, window.innerHeight);
                    state.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                   
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                    state.scene.add(ambientLight);
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(10, 10, 5);
                    state.scene.add(directionalLight);
                   
                    this.createGlass();
                }
               
                createGlass() {
                    state.glassGroup = new THREE.Group();
                   
                    const stemGeometry = new THREE.CylinderGeometry(0.02, 0.025, 0.3, 16);
                    const stemMaterial = new THREE.MeshPhongMaterial({ color: 0xFFD700, shininess: 100 });
                    const stem = new THREE.Mesh(stemGeometry, stemMaterial);
                    stem.position.y = 0.15;
                    state.glassGroup.add(stem);
                   
                    const bowlGeometry = new THREE.CylinderGeometry(0.12, 0.09, 0.25, 32);
                    const bowlMaterial = new THREE.MeshPhysicalMaterial({
                        color: 0xFFFFFF,
                        transparent: true,
                        opacity: 0.3,
                        transmission: 0.9,
                        roughness: 0.1,
                        clearcoat: 1.0
                    });
                    const bowl = new THREE.Mesh(bowlGeometry, bowlMaterial);
                    bowl.position.y = 0.4;
                    state.glassGroup.add(bowl);
                   
                    const liquidGeometry = new THREE.SphereGeometry(0.1, 32, 32, 0, Math.PI * 2, 0, Math.PI / 2);
                    const liquidMaterial = new THREE.MeshPhongMaterial({
                        color: 0xFFF8DC,
                        transparent: true,
                        opacity: 0.8
                    });
                    const liquid = new THREE.Mesh(liquidGeometry, liquidMaterial);
                    liquid.position.y = 0.35;
                    liquid.scale.y = 0.5;
                    state.glassGroup.add(liquid);
                   
                    state.scene.add(state.glassGroup);
                    state.glassGroup.visible = false;
                }
               
                async initMediaPipe() {
                    try {
                        this.updateDebug('mediaPipe', 'debug-value', '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...');
                       
                        const { FilesetResolver, HandLandmarker } = mp.tasks.vision;
                       
                        const vision = await FilesetResolver.forVisionTasks(
                            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm"
                        );
                       
                        state.handLandmarker = await HandLandmarker.createFromOptions(vision, {
                            baseOptions: {
                                modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                                delegate: "GPU"
                            },
                            runningMode: "VIDEO",
                            numHands: 1,
                            minHandDetectionConfidence: 0.5,
                            minTrackingConfidence: 0.5
                        });
                       
                        this.updateDebug('mediaPipe', 'debug-good', '‚úÖ –ì–æ—Ç–æ–≤–æ');
                    } catch (error) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ MediaPipe:', error);
                        this.updateDebug('mediaPipe', 'debug-bad', '‚ùå –ü–æ–º–∏–ª–∫–∞');
                        throw error;
                    }
                }
               
                async startCamera() {
                    try {
                        let stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: CONFIG.INITIAL_CAMERA }
                        });
                       
                        if (!stream) {
                            stream = await navigator.mediaDevices.getUserMedia({
                                video: { facingMode: CONFIG.FALLBACK_CAMERA }
                            });
                            state.isFrontCamera = false;
                        }
                       
                        elements.videoBackground.srcObject = stream;
                        state.videoStream = stream;
                       
                        await new Promise(resolve => {
                            elements.videoBackground.onloadedmetadata = () => {
                                elements.videoBackground.play();
                                resolve();
                            };
                        });
                       
                        elements.videoBackground.style.transform = state.isFrontCamera ? 'scaleX(-1)' : 'scaleX(1)';
                        elements.videoBackground.style.display = 'block';
                        elements.cameraSwitchBtn.style.display = 'flex';
                       
                        this.updateDebug('camera', 'debug-good', state.isFrontCamera ? '–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞' : '–ó–∞–¥–Ω—è');
                    } catch (error) {
                        throw new Error('CAMERA_ERROR');
                    }
                }
               
                async switchCamera() {
                    // –ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ —Ç–≤–æ—î–º—É –∫–æ–¥—É - –∑—É–ø–∏–Ω–∏—Ç–∏ –ø–æ—Ç—ñ–∫, –ø–µ—Ä–µ–º–∫–Ω—É—Ç–∏ facingMode —Ç–æ—â–æ
                    // (–¥–ª—è —Å—Ç–∏—Å–ª–æ—Å—Ç—ñ –Ω–µ –¥—É–±–ª—é—é, –∞–ª–µ –¥–æ–¥–∞–π –∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª—É)
                }
               
                detectHands() {
                    if (!state.handLandmarker || !state.isRunning) return;
                    const video = elements.videoBackground;
                    if (video.readyState < 2) return;
                   
                    const results = state.handLandmarker.detectForVideo(video, performance.now());
                   
                    if (results.landmarks && results.landmarks.length > 0) {
                        state.handNotDetectedCount = 0;
                        const landmarks = results.landmarks[0];
                        state.detectedHands = [{ landmarks: this.smoothLandmarks(landmarks) }];
                        debugEls.hands.textContent = '1';
                        debugEls.hands.className = 'debug-value debug-good';
                        this.checkPinchGesture(landmarks);
                        this.updateGlassPosition();
                    } else {
                        state.handNotDetectedCount++;
                        state.detectedHands = [];
                        debugEls.hands.textContent = '0';
                        if (state.handNotDetectedCount > CONFIG.HAND_NOT_DETECTED_THRESHOLD) {
                            this.hideGlass();
                        }
                    }
                }
               
                // –î–æ–¥–∞–π —ñ–Ω—à—ñ –º–µ—Ç–æ–¥–∏: smoothLandmarks, lerp, checkPinchGesture, updateGlassPosition, hideGlass, showGreeting, createSparkles —Ç–æ—â–æ –∑ —Ç–≤–æ–≥–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—É
               
                startRenderLoop() {
                    const render = () => {
                        this.detectHands();
                        state.renderer.render(state.scene, state.camera);
                        state.animationFrameId = requestAnimationFrame(render);
                    };
                    render();
                }
               
                setupEventListeners() {
                    elements.startButton.addEventListener('click', () => this.hideLoading());
                    elements.cameraSwitchBtn.addEventListener('click', () => this.switchCamera());
                    window.addEventListener('resize', () => {
                        state.camera.updateProjectionMatrix();
                        state.renderer.setSize(window.innerWidth, window.innerHeight);
                    });
                }
               
                updateDebug(id, cls, text) {
                    if (debugEls[id]) {
                        debugEls[id].textContent = text;
                        debugEls[id].className = `debug-value ${cls}`;
                    }
                }
               
                hideLoading() {
                    elements.loading.style.display = 'none';
                    elements.startButton.style.display = 'none';
                    state.isRunning = true;
                }
               
                handleError(error) {
                    // –¢–≤—ñ–π –∫–æ–¥ –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫
                }
            }
           
            window.addEventListener('DOMContentLoaded', () => {
                new BirthdayARApp();
            });
        })();
    </script>
</body>
</html>

